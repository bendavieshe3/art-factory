{% comment %}
Order Form Management JavaScript Component

This component handles form validation, generation count management, 
total calculation, and form persistence for the order form.

Parameters:
- max_generations (optional): Maximum allowed generations, defaults to 50
- default_batch_size (optional): Default batch size, defaults to 4

Usage:
{% include 'components/js/order_form_management.html' %}
{% include 'components/js/order_form_management.html' with max_generations=100 %}
{% endcomment %}

<script>
// Generation count control functions
window.changeGenerationCount = function(delta) {
    const input = document.getElementById('generationCount');
    const currentValue = parseInt(input.value) || 1;
    const newValue = Math.max(1, Math.min({{ max_generations|default:'50' }}, currentValue + delta));
    input.value = newValue;
    updateTotalProducts();
    saveFormValues();
};

// Update total products calculation
function updateTotalProducts() {
    const generationCount = parseInt(document.getElementById('generationCount').value) || 1;
    const batchSize = parseInt(document.getElementById('batchSize').value) || {{ default_batch_size|default:'4' }};
    const totalProducts = generationCount * batchSize;
    
    const totalEl = document.getElementById('totalProducts');
    totalEl.textContent = totalProducts;
    
    // Add visual styling based on total
    if (totalProducts > 10) {
        totalEl.className = 'form-control-plaintext fw-bold text-primary';
    } else {
        totalEl.className = 'form-control-plaintext fw-bold';
    }
}

// Save form values to localStorage
function saveFormValues() {
    try {
        const formData = {
            machine: document.getElementById('machine')?.value || '',
            prompt: document.getElementById('prompt')?.value || '',
            negative_prompt: document.getElementById('negative_prompt')?.value || '',
            title: document.getElementById('title')?.value || '',
            project: document.getElementById('project')?.value || '',
            generationCount: document.getElementById('generationCount')?.value || '1',
            batchSize: document.getElementById('batchSize')?.value || '4'
        };
        
        // Save advanced parameters
        const advancedParams = {};
        const parameterInputs = document.querySelectorAll('#advancedParams input, #advancedParams select');
        parameterInputs.forEach(input => {
            if (input.value !== '') {
                advancedParams[input.name] = input.value;
            }
        });
        formData.advancedParams = advancedParams;
        
        localStorage.setItem('orderFormData', JSON.stringify(formData));
        console.log('Form data saved:', formData);
    } catch (e) {
        console.error('Error saving form data:', e);
    }
}

// Load form values from localStorage
function loadFormValues() {
    const savedData = localStorage.getItem('orderFormData');
    if (savedData) {
        try {
            const formData = JSON.parse(savedData);
            console.log('Loading saved form data:', formData);
            
            // Restore basic form fields with null checks
            const machineField = document.getElementById('machine');
            if (formData.machine && machineField) {
                machineField.value = formData.machine;
                // Trigger change event to load parameters
                machineField.dispatchEvent(new Event('change'));
            }
            
            const promptField = document.getElementById('prompt');
            if (formData.prompt && promptField) promptField.value = formData.prompt;
            
            const negativePromptField = document.getElementById('negative_prompt');
            if (formData.negative_prompt && negativePromptField) negativePromptField.value = formData.negative_prompt;
            
            const titleField = document.getElementById('title');
            if (formData.title && titleField) titleField.value = formData.title;
            
            const projectField = document.getElementById('project');
            if (formData.project && projectField) projectField.value = formData.project;
            
            const generationCountField = document.getElementById('generationCount');
            if (formData.generationCount && generationCountField) generationCountField.value = formData.generationCount;
            
            const batchSizeField = document.getElementById('batchSize');
            if (formData.batchSize && batchSizeField) batchSizeField.value = formData.batchSize;
            
            // Restore advanced parameters after a short delay to ensure they're generated
            if (formData.advancedParams) {
                setTimeout(() => {
                    for (const [key, value] of Object.entries(formData.advancedParams)) {
                        const input = document.getElementById(key);
                        if (input) {
                            input.value = value;
                        }
                    }
                    updateTotalProducts();
                }, 500);
            }
            
            // Update calculation after restoring values
            updateTotalProducts();
            console.log('Form values loaded successfully');
        } catch (e) {
            console.error('Error loading saved form data:', e);
            // Don't automatically clear - let user decide
            console.log('Warning: Saved form data may be corrupted but keeping it for debugging');
        }
    } else {
        console.log('No saved form data found');
    }
}

// Test function to check if form persistence is working
window.testFormPersistence = function() {
    console.log('Testing form persistence...');
    
    // Check localStorage availability
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        console.log('localStorage is available');
    } catch (e) {
        console.error('localStorage is NOT available:', e);
        return;
    }
    
    // Check if elements exist
    const formFields = ['machine', 'prompt', 'negative_prompt', 'title', 'project', 'generationCount', 'batchSize'];
    formFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        console.log(`Field ${fieldId}:`, element ? `exists (value: "${element.value}")` : 'NOT FOUND');
    });
    
    // Check ALL localStorage keys
    console.log('All localStorage keys:', Object.keys(localStorage));
    
    // Check saved data specifically
    const savedData = localStorage.getItem('orderFormData');
    if (savedData) {
        console.log('Found saved form data:', JSON.parse(savedData));
    } else {
        console.log('No saved form data found in localStorage');
    }
    
    // Manually save some test data
    console.log('Manually saving test data...');
    const testData = { test: 'value', timestamp: new Date().toISOString() };
    localStorage.setItem('orderFormData', JSON.stringify(testData));
    
    // Verify it was saved
    const verifyData = localStorage.getItem('orderFormData');
    console.log('Verification - saved data:', verifyData);
    
    // Trigger normal save
    console.log('Triggering normal saveFormValues...');
    saveFormValues();
    
    // Check again
    const afterSave = localStorage.getItem('orderFormData');
    console.log('After saveFormValues:', afterSave);
};

// Initialize form management event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('Form management component initialized');
    
    // Add event listeners for generation count and batch size changes
    const batchSizeElement = document.getElementById('batchSize');
    if (batchSizeElement) {
        batchSizeElement.addEventListener('change', function() {
            updateTotalProducts();
            saveFormValues();
        });
        console.log('Batch size event listener attached');
    } else {
        console.warn('Batch size element not found');
    }
    
    const generationCountElement = document.getElementById('generationCount');
    if (generationCountElement) {
        generationCountElement.addEventListener('input', function() {
            updateTotalProducts();
            saveFormValues();
        });
        console.log('Generation count event listener attached');
    } else {
        console.warn('Generation count element not found');
    }
    
    // Add event listeners for form field changes to save values
    const formFields = ['machine', 'prompt', 'negative_prompt', 'title', 'project'];
    let attachedCount = 0;
    formFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            element.addEventListener('change', saveFormValues);
            element.addEventListener('input', saveFormValues);
            attachedCount++;
        } else {
            console.warn(`Form field element not found: ${fieldId}`);
        }
    });
    console.log(`Attached event listeners to ${attachedCount} form fields`);
    
    // Expose test function globally
    window.testFormPersistence = testFormPersistence;
    console.log('Form persistence test function available as window.testFormPersistence()');
});
</script>