{% extends 'base.html' %}

{% block page_description %}
<p>Select an AI model and create your generation request.</p>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Create New Order</h2>
    
    <form id="orderForm">
        <div class="form-group">
            <label for="title">Order Title (Optional)</label>
            <input type="text" id="title" name="title" placeholder="e.g., Fantasy landscapes for project X">
        </div>
        
        <div class="form-group">
            <label for="prompt">Prompt *</label>
            <textarea id="prompt" name="prompt" rows="3" placeholder="A beautiful landscape with mountains and a lake at sunset" required></textarea>
        </div>
        
        <div class="form-group">
            <label for="machine">AI Model *</label>
            <select id="machine" name="machine" required>
                <option value="">Select an AI model...</option>
                {% for machine in factory_machines %}
                    <option value="{{ machine.id }}" 
                            data-provider="{{ machine.provider }}"
                            data-modality="{{ machine.modality }}"
                            data-description="{{ machine.description }}">
                        {{ machine.display_name }} ({{ machine.provider }})
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div id="machineDescription" class="hidden">
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <p id="descriptionText"></p>
            </div>
        </div>
        
        <div class="form-group">
            <label for="quantity">Number of Images</label>
            <input type="number" id="quantity" name="quantity" value="1" min="1" max="10">
        </div>
        
        <div class="form-group">
            <label for="project_name">Project (Optional)</label>
            <input type="text" id="project_name" name="project_name" placeholder="Project name for organization">
        </div>
        
        <button type="submit" id="submitBtn">Place Order</button>
    </form>
</div>

{% if factory_machines|length == 0 %}
<div class="card">
    <h3>No AI Models Available</h3>
    <p>No factory machines are currently configured. Please add some in the Django admin interface.</p>
    <a href="{% url 'admin:main_factorymachinedefinition_add' %}" target="_blank">Add Factory Machine</a>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const machineSelect = document.getElementById('machine');
    const descriptionDiv = document.getElementById('machineDescription');
    const descriptionText = document.getElementById('descriptionText');
    const form = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    
    // Show machine description when selected
    machineSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const description = selectedOption.dataset.description;
            const provider = selectedOption.dataset.provider;
            const modality = selectedOption.dataset.modality;
            
            descriptionText.innerHTML = `
                <strong>${selectedOption.text}</strong><br>
                <strong>Type:</strong> ${modality}<br>
                <strong>Description:</strong> ${description}
            `;
            descriptionDiv.classList.remove('hidden');
        } else {
            descriptionDiv.classList.add('hidden');
        }
    });
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Placing Order...';
        
        const formData = {
            title: document.getElementById('title').value,
            prompt: document.getElementById('prompt').value,
            machine_id: document.getElementById('machine').value,
            quantity: parseInt(document.getElementById('quantity').value),
            project_name: document.getElementById('project_name').value,
            parameters: {} // Basic parameters for now
        };
        
        fetch('{% url "main:place_order_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order placed successfully! Order ID: ' + data.order_id);
                form.reset();
                descriptionDiv.classList.add('hidden');
            } else {
                alert('Error placing order: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error placing order: ' + error.message);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Place Order';
        });
    });
});
</script>
{% endblock %}